## 项目基建

`eslint prettier lint-staged husky npmrc nvmrc turborepo engines packageManager editorconfig tailwind`

## 国际化

middleware.ts

```js
import { NextResponse } from 'next/server'
import { match } from '@formatjs/intl-localematcher'
import Negotiator from 'negotiator'
import type { NextRequest } from 'next/server'

const locales = ['zh-CN', 'en-US']
const defaultLocale = 'zh-CN'

function getLocale(request: NextRequest) {
  const headers = {
    'accept-language': request.headers.get('accept-language') || ''
  }
  const languages = new Negotiator({ headers }).languages()
  return match(languages, locales, defaultLocale)
}

const { pathname } = request.nextUrl

const pathnameHasLocale = locales.some(
  (locale) => pathname.startsWith(`/${locale}/`) || pathname === `/${locale}`
)

if (pathnameHasLocale) return

const locale = getLocale(request)

if (locale === 'zh-CN') return

request.nextUrl.pathname = `/${locale}${pathname}`
return Response.redirect(request.nextUrl)

export const config = {
  matcher: [
    {
      source: '/((?!api|_next/static|_next/image|favicon.ico).*)',
      missing: [
        { type: 'header', key: 'next-router-prefetch' },
        { type: 'header', key: 'purpose', value: 'prefetch' }
      ]
    }
  ]
}
```

获取多语言 Json

```js
import 'server-only'

const dictionaries = {
  'en-US': () => import('@/config/en-US.json').then((module) => module.default),
  'zh-CN': () => import('@/config/zh-CN.json').then((module) => module.default)
}

export type Locale = 'en-US' | 'zh-CN'

export const getLang = async (locale: Locale) => dictionaries[locale]()
```

## SSR

关键是指定`fetch`的第二个参数为`{ cache: 'no-store' }`

```js
async function getProjects() {
  const res = await fetch(`https://...`, { cache: 'no-store' })
  const projects = await res.json()

  return projects
}

export default async function Dashboard() {
  const projects = await getProjects()

  return (
    <ul>
      {projects.map((project) => (
        <li key={project.id}>{project.name}</li>
      ))}
    </ul>
  )
}
```

## SSG

关键是将  `fetch()`  默认为  `cache: 'force-cache'`（也可以指定动态路径`generateStaticParams`，相当于 `pages router` 的 `getStaticPaths`，如果指定 `fallback` 只有 `true` 和 `false` ，没有 `blocking` 了）

```js
async function getProjects() {
  const res = await fetch(`https://...`)
  const projects = await res.json()

  return projects
}

export default async function Index() {
  const projects = await getProjects()

  return projects.map((project) => <div>{project.name}</div>)
}
```

## ISR

关键是指定`fetch`的第二个参数为`{ revalidate: 'xxx秒' }`

```js
async function getPosts() {
  const res = await fetch(`https://.../posts`, { next: { revalidate: 60 } })
  const data = await res.json()

  return data.posts
}

export default async function PostList() {
  const posts = await getPosts()

  return posts.map((post) => <div>{post.name}</div>)
}
```

## 水合不一致问题

`suppressHydrationWarning`

`https://react.dev/reference/react-dom/client/hydrateRoot#handling-different-client-and-server-content`

可能不规则的 html 标签写法，如 p>div，或者数据水合出错

```jsx
const text = typeof window !== 'undefined' ? '1' : '2'

const [text, setText] = useState('1')

useEffect(() => {
  setText('2')
}, [])
```

## 主题切换

```js
import type { Metadata } from 'next'
import './globals.css'
import { ThemeProvider } from '@/ui/ThemeProvider'

export const metadata: Metadata = {
  title: 'Create Next App',
  description: 'Generated by create next app'
}

export default function RootLayout({
  children
}: {
  children: React.ReactNode
}) {
  return (
    <html lang="en" suppressHydrationWarning>
      <body className="bg-white dark:bg-black">
        <ThemeProvider attribute="class" defaultTheme="light">
          {children}
        </ThemeProvider>
      </body>
    </html>
  )
}
```

```js
'use client'

import * as React from 'react'
import { ThemeProvider as NextThemesProvider } from 'next-themes'
type ThemeProviderProps = Parameters<typeof NextThemesProvider>[0]

export function ThemeProvider({ children, ...props }: ThemeProviderProps) {
  return <NextThemesProvider {...props}>{children}</NextThemesProvider>
}
```

```js
'use client'

import { useTheme } from 'next-themes'

function ThemeToggle() {
  const { theme, setTheme } = useTheme()

  return (
    <button
      className="mt-16 px-4 py-2 text-white dark:text-black bg-black dark:bg-white font-semibold rounded-md"
      onClick={() => {
        setTheme(theme === 'light' ? 'dark' : 'light')
      }}
    >
      Change Theme
    </button>
  )
}

export default ThemeToggle
```

```js
<html lang="en" suppressHydrationWarning>
  <body>
    <ThemeProvider>{children}</ThemeProvider>
  </body>
</html>
```

## title 插槽

```js
title: {
    template: '%s | Acme Dashboard',
    default: 'Acme Dashboard',
  },
```

## 走 CDN 时打包不一致问题

```js
const { execSync } = require('node:child_process')

generateBuildId: async () => {
  try {
    // 由于docker那边没有git,所以不能这样
    const gitHash = execSync('git rev-parse HEAD').toString().trim()
    return gitHash
  } catch (error) {
    console.error('获取Git提交哈希时发生错误:', error)
    return null // 返回null或其他默认值作为构建ID
  }
}
```

## 页面 304 问题

```js
export const dynamic = 'force-dynamic'
```

## 路径别名
